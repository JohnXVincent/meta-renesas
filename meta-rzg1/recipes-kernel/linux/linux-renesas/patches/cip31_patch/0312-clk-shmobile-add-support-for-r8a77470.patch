From b0e1f997b51bb1309ba052ca57f1e804eb54fd09 Mon Sep 17 00:00:00 2001
From: "Nguyen Van Tu [FGA.AIS]" <TuNV16@fsoft.com.vn>
Date: Wed, 14 Nov 2018 16:22:05 +0700
Subject: [PATCH 312/641] clk: shmobile: add support for r8a77470

The previous commit (4be22c15) removed commpatible defined for r8a77470
This commit add it again, and prevent conflict with other SoCs

Signed-off-by: Binh Nguyen <binh.nguyen.uw@rvc.renesas.com>
Signed-off-by: Nguyen Van Linh [FGA.BU13] <LinhNV25@fsoft.com.vn>
Signed-off-by: vietn <vietn@fsoft.com.vn>
Signed-off-by: Nguyen Van Tu [FGA.AIS] <TuNV16@fsoft.com.vn>
---
 drivers/clk/shmobile/Makefile        |  1 +
 drivers/clk/shmobile/clk-rcar-gen2.c | 49 +++++++++++++++++++++++++++++++-----
 2 files changed, 44 insertions(+), 6 deletions(-)

diff --git a/drivers/clk/shmobile/Makefile b/drivers/clk/shmobile/Makefile
index b339c0b..2412eb9 100644
--- a/drivers/clk/shmobile/Makefile
+++ b/drivers/clk/shmobile/Makefile
@@ -4,6 +4,7 @@ obj-$(CONFIG_ARCH_R8A73A4)		+= clk-r8a73a4.o
 obj-$(CONFIG_ARCH_R8A7740)		+= clk-r8a7740.o
 obj-$(CONFIG_ARCH_R8A7743)		+= clk-rcar-gen2.o
 obj-$(CONFIG_ARCH_R8A7745)		+= clk-rcar-gen2.o
+obj-$(CONFIG_ARCH_R8A77470)		+= clk-rcar-gen2.o
 obj-$(CONFIG_ARCH_R8A7778)		+= clk-r8a7778.o
 obj-$(CONFIG_ARCH_R8A7779)		+= clk-r8a7779.o
 obj-$(CONFIG_ARCH_R8A7790)		+= clk-rcar-gen2.o
diff --git a/drivers/clk/shmobile/clk-rcar-gen2.c b/drivers/clk/shmobile/clk-rcar-gen2.c
index be7c0dc..aed6f99 100644
--- a/drivers/clk/shmobile/clk-rcar-gen2.c
+++ b/drivers/clk/shmobile/clk-rcar-gen2.c
@@ -21,6 +21,8 @@
 #include <linux/spinlock.h>
 #include <linux/soc/renesas/rcar-rst.h>
 
+static bool is_g1c;
+
 struct rcar_gen2_cpg {
 	struct clk_onecell_data data;
 	spinlock_t lock;
@@ -283,6 +285,11 @@ static const struct cpg_pll_config cpg_pll_configs[8] __initconst = {
 	{ 2, 240, 122 }, { 2, 240, 102 }, { 2, 208, 106 }, { 2, 208,  88 },
 };
 
+static const struct cpg_pll_config g1c_cpg_pll_configs[4] __initconst = {
+	{ 1, 78, 50 }, { 1, 60, 56 },
+	{ /* Invalid */ }, { 1, 52, 50 },
+};
+
 /* SDHI divisors */
 static const struct clk_div_table cpg_sdh_div_table[] = {
 	{  0,  2 }, {  1,  3 }, {  2,  4 }, {  3,  6 },
@@ -296,6 +303,11 @@ static const struct clk_div_table cpg_sd01_div_table[] = {
 	{ 10, 36 }, { 11, 48 }, { 12, 10 }, {  0,  0 },
 };
 
+static const struct clk_div_table g1c_cpg_sd01_div_table[] = {
+	{  5, 12 }, {  6, 16 }, {  7, 18 }, {  8, 24 },
+	{ 10, 36 }, { 11, 48 }, { 12, 10 }, {  0,  0 },
+};
+
 /* -----------------------------------------------------------------------------
  * Initialization
  */
@@ -351,6 +363,11 @@ static const struct of_device_id cpg_of_match[] = {
 		.compatible = "renesas,r8a7745-cpg-clocks",
 		.data = &fix_pll0_ratio,
 	},
+
+	{
+		.compatible = "renesas,r8a77470-cpg-clocks",
+		.data = &var_pll0_ratio,
+	},
 	{}
 };
 
@@ -393,13 +410,19 @@ rcar_gen2_cpg_register_clock(struct device_node *np, struct rcar_gen2_cpg *cpg,
 			mult = ((value >> 24) & ((1 << 7) - 1)) + 1;
 		}
 	} else if (!strcmp(name, "pll1")) {
-		mult = config->pll1_mult / 2;
+		if (is_g1c)
+			mult = config->pll1_mult;
+		else
+			mult = config->pll1_mult / 2;
 	} else if (!strcmp(name, "pll3")) {
 		parent_name = "main";
 		mult = config->pll3_mult;
 	} else if (!strcmp(name, "lb")) {
 		parent_name = "pll1";
-		div = cpg_mode & BIT(18) ? 36 : 24;
+		if (is_g1c)
+			div = 12;
+		else
+			div = cpg_mode & BIT(18) ? 36 : 24;
 	} else if (!strcmp(name, "qspi")) {
 		parent_name = "pll1_div2";
 		div = (cpg_mode & (BIT(3) | BIT(2) | BIT(1))) == BIT(2)
@@ -409,11 +432,18 @@ rcar_gen2_cpg_register_clock(struct device_node *np, struct rcar_gen2_cpg *cpg,
 		table = cpg_sdh_div_table;
 		shift = 8;
 	} else if (!strcmp(name, "sd0")) {
-		table = cpg_sd01_div_table;
+		parent_name = "pll1";
+		if (is_g1c)
+			table = g1c_cpg_sd01_div_table;
+		else
+			table = cpg_sd01_div_table;
 		shift = 4;
 	} else if (!strcmp(name, "sd1")) {
 		parent_name = "pll1";
-		table = cpg_sd01_div_table;
+		if (is_g1c)
+			table = g1c_cpg_sd01_div_table;
+		else
+			table = cpg_sd01_div_table;
 		shift = 0;
 	} else if (!strcmp(name, "z")) {
 		if (data->is_devider_fixed)
@@ -476,7 +506,13 @@ static void __init rcar_gen2_cpg_clocks_init(struct device_node *np)
 	if (WARN_ON(cpg->reg == NULL))
 		return;
 
-	config = &cpg_pll_configs[CPG_PLL_CONFIG_INDEX(cpg_mode)];
+	if (of_machine_is_compatible("renesas,r8a77470")) {
+		config = &g1c_cpg_pll_configs[CPG_PLL_CONFIG_INDEX(cpg_mode) >> 1];
+		is_g1c = true;
+	} else {
+		config = &cpg_pll_configs[CPG_PLL_CONFIG_INDEX(cpg_mode)];
+		is_g1c = false;
+	}
 
 	for (i = 0; i < num_clks; ++i) {
 		const char *name;
@@ -495,7 +531,8 @@ static void __init rcar_gen2_cpg_clocks_init(struct device_node *np)
 
 	of_clk_add_provider(np, of_clk_src_onecell_get, &cpg->data);
 
-	cpg_mstp_add_clk_domain(np);
+	if (is_g1c == false)
+		cpg_mstp_add_clk_domain(np);
 }
 CLK_OF_DECLARE(rcar_gen2_cpg_clks, "renesas,rcar-gen2-cpg-clocks",
 	       rcar_gen2_cpg_clocks_init);
-- 
2.7.4

