From c20184afeecc32ddad047ee43e5fc005d0e204a3 Mon Sep 17 00:00:00 2001
From: TamPT8 <tampt8@fsoft.com.vn>
Date: Mon, 16 Dec 2019 16:37:34 +0700
Subject: [PATCH] phy: rcar-gen2: add support for r8a7744 usb otg

Signed-off-by: Kha Tran <kha.tran.px@rvc.renesas.com>
Signed-off-by: Nguyen Van Linh [FGA.BU13] <LinhNv25@fsoft.com.vn>
Signed-off-by: vietn <vietn@fsoft.com.vn>
Signed-off-by: Duy Nguyen <duynt26@fsoft.com.vn>
Signed-off-by: TamPT8 <tampt8@fsoft.com.vn>
---
 drivers/phy/phy-rcar-gen2.c | 32 +++++++++++++++++++++++---------
 1 file changed, 23 insertions(+), 9 deletions(-)

diff --git a/drivers/phy/phy-rcar-gen2.c b/drivers/phy/phy-rcar-gen2.c
index 2269e1e..e212085 100644
--- a/drivers/phy/phy-rcar-gen2.c
+++ b/drivers/phy/phy-rcar-gen2.c
@@ -236,7 +236,9 @@ static int rcar_gen2_phy_power_on(struct phy *p)
 	writew(value, usbhs_base + USBHS_LPSTS);
 
 	/* USBHS_UGCTRL_CONNECT bit only exists on RZG1H,M,N,E SoC USBHS_UGSTS reg */
-	if (of_machine_is_compatible("renesas,r8a7743") || of_machine_is_compatible("renesas,r8a7745")) {
+	if (of_machine_is_compatible("renesas,r8a7743")
+		|| of_machine_is_compatible("renesas,r8a7744")
+		|| of_machine_is_compatible("renesas,r8a7745")) {
 		for (i = 0; i < 20; i++) {
 			value = readl(usbhs_base + USBHS_UGSTS);
 			if ((value & USBHS_UGSTS_LOCK) == USBHS_UGSTS_LOCK) {
@@ -274,7 +276,9 @@ static int rcar_gen2_phy_power_off(struct phy *p)
 	spin_lock_irqsave(&drv->lock, flags);
 
 	/* Power off USBHS PHY */
-	if (of_machine_is_compatible("renesas,r8a7743") || of_machine_is_compatible("renesas,r8a7745")) {
+	if (of_machine_is_compatible("renesas,r8a7743")
+		|| of_machine_is_compatible("renesas,r8a7744")
+		|| of_machine_is_compatible("renesas,r8a7745")) {
 		value = readl(usbhs_base + USBHS_UGCTRL);
 		value &= ~USBHS_UGCTRL_CONNECT;
 		writel(value, usbhs_base + USBHS_UGCTRL);
@@ -383,14 +387,16 @@ static void gpio_id_work(struct work_struct *work)
 	if (!id) {
 		if (of_machine_is_compatible("renesas,r8a7745"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_PCI | USBHS_UGCTRL2_USB2SEL_PCI);
-		else if (of_machine_is_compatible("renesas,r8a7743"))
+		else if (of_machine_is_compatible("renesas,r8a7743") ||
+			of_machine_is_compatible("renesas,r8a7744"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_PCI | USBHS_UGCTRL2_USB2SEL_USB30);
 		else if (of_machine_is_compatible("renesas,r8a77470"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_USB20);
 	} else {
 		if (of_machine_is_compatible("renesas,r8a7745"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HS_USB | USBHS_UGCTRL2_USB2SEL_PCI);
-		else if (of_machine_is_compatible("renesas,r8a7743"))
+		else if (of_machine_is_compatible("renesas,r8a7743") ||
+			of_machine_is_compatible("renesas,r8a7744"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HS_USB | USBHS_UGCTRL2_USB2SEL_USB30);
 		else if (of_machine_is_compatible("renesas,r8a77470"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HSUSB_R8A77470);
@@ -421,14 +427,16 @@ static void gpio_vbus_work(struct work_struct *work)
 	if (id) {
 		if (of_machine_is_compatible("renesas,r8a7745"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HS_USB | USBHS_UGCTRL2_USB2SEL_PCI);
-		else if (of_machine_is_compatible("renesas,r8a7743"))
+		else if (of_machine_is_compatible("renesas,r8a7743") ||
+			of_machine_is_compatible("renesas,r8a7744"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HS_USB | USBHS_UGCTRL2_USB2SEL_USB30);
 		else if (of_machine_is_compatible("renesas,r8a77470"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_HSUSB_R8A77470);
 	} else {
 		if (of_machine_is_compatible("renesas,r8a7745"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_PCI | USBHS_UGCTRL2_USB2SEL_PCI);
-		else if (of_machine_is_compatible("renesas,r8a7743"))
+		else if (of_machine_is_compatible("renesas,r8a7743") ||
+			of_machine_is_compatible("renesas,r8a7744"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_PCI | USBHS_UGCTRL2_USB2SEL_USB30);
 		else if (of_machine_is_compatible("renesas,r8a77470"))
 			rcar_gen2_phy_switch(channel, USBHS_UGCTRL2_USB0SEL_USB20);
@@ -540,7 +548,9 @@ static int rcar_gen2_usb_set_peripheral(struct usb_otg *otg,
 		otg->gadget = gadget;
 
 	/* initialize connection state */
-		if (of_machine_is_compatible("renesas,r8a7743") || of_machine_is_compatible("renesas,r8a7745")) {
+		if (of_machine_is_compatible("renesas,r8a7743")
+			|| of_machine_is_compatible("renesas,r8a7744")
+			|| of_machine_is_compatible("renesas,r8a7745")) {
 			gpio_vbus_irq(channel->irq_vbus, channel);
 		} else if (of_machine_is_compatible("renesas,r8a77470"))
 			gpio_vbus_irq(channel->irq_id, channel);
@@ -841,7 +851,9 @@ static int rcar_gen2_phy_probe(struct platform_device *pdev)
 			of_node_put(np);
 			return error;
 		}
-		if (of_machine_is_compatible("renesas,r8a7743") || of_machine_is_compatible("renesas,r8a7745")) {
+		if (of_machine_is_compatible("renesas,r8a7743")
+			|| of_machine_is_compatible("renesas,r8a7744")
+			|| of_machine_is_compatible("renesas,r8a7745")) {
 			channel->select_mask = select_mask[channel_num];
 			phys_per_channel = PHYS_PER_CHANNEL;
 		} else if (of_machine_is_compatible("renesas,r8a77470")) {
@@ -854,7 +866,9 @@ static int rcar_gen2_phy_probe(struct platform_device *pdev)
 
 			phy->channel = channel;
 			phy->number = n;
-			if (of_machine_is_compatible("renesas,r8a7743") || of_machine_is_compatible("renesas,r8a7745"))
+			if (of_machine_is_compatible("renesas,r8a7743")
+				|| of_machine_is_compatible("renesas,r8a7744")
+				|| of_machine_is_compatible("renesas,r8a7745"))
 				phy->select_value = select_value[channel_num][n];
 			else if (of_machine_is_compatible("renesas,r8a77470")) {
 				if (drv->channels->use_otg)
-- 
2.7.4

