; Copyright (C) 2021 Renesas Electronics Corp.
; Author: Biju Das <biju.das.jz@bp.renesas.com>

getdir BASE_PATH
strconcat BASE_PATH "\"

IMAGE_NUM=2
IMAGE_ARR=IMAGE_NUM-1

strdim PROGRAM_SIZE_TABLE IMAGE_NUM
strdim FLASH_ADDRESS_TABLE IMAGE_NUM
strdim FILE_NAME_TABLE IMAGE_NUM

; ##### PROGRAM_ADDRESS_TABLE[X]
PROGRAM_SIZE_TABLE[0] = "PROGRAM_SIZE_BL2_BP"
PROGRAM_SIZE_TABLE[1] = "PROGRAM_SIZE_FIP"

; ##### FLASH_ADDRESS_TABLE[X]
FLASH_ADDRESS_TABLE[0] = "FLASH_ADDRESS_BL2_BP"
FLASH_ADDRESS_TABLE[1] = "FLASH_ADDRESS_FIP"

; ##### FILE_NAME_TABLE[X]
FILE_NAME_TABLE[0] = "FILENAME_BL2_BP"
FILE_NAME_TABLE[1] = "FILENAME_FIP"


; #####

setsync 1
sendln "XCS"
waitregex "Clear OK?"
sendln "y"

for i 0 IMAGE_ARR
  strmatch FILE_NAME_TABLE[i] ".bin"
  if result then
    FLASH_ADDRESS=FLASH_ADDRESS_TABLE[i]
    PROGRAM_SIZE=PROGRAM_SIZE_TABLE[i]
    FILE_NAME=FILE_NAME_TABLE[i]

    call write_flash

  endif
next
exit

; #####
; Flash Writer
; #####

:launch_writer

sendln "XLS3"

waitregex "Please Input"

return

; #####
;  PROGRAM_ADDRESS
;  BASE_PATH
;  FLASH_ADDRESS
;  FILE_NAME
; #####

:write_flash

call launch_writer

sendln PROGRAM_SIZE
waitregex "Please Input"

sendln FLASH_ADDRESS
waitregex "please send"

FILE_PATH=BASE_PATH
strconcat FILE_PATH FILE_NAME
sendfile FILE_PATH 1
waitregex "SPI Data Clear"

waitregex ">"

return
